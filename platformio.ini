[env:stm32h723vg]
platform = ststm32
board = nucleo_h723zg

; 上传和调试接口 - 使用CMSIS-DAP
upload_protocol = cmsis-dap
debug_tool = cmsis-dap

; 编译器标志 - 使用软浮点避免VFP冲突
build_flags = 
    -DUSE_PWR_LDO_SUPPLY
    -DUSE_HAL_DRIVER
    -DSTM32H723xx
    -mcpu=cortex-m7
    -mfloat-abi=soft
    -mthumb
    -Wall
    -fdata-sections
    -ffunction-sections
    -specs=nano.specs
    -Wl,--gc-sections
    -Wl,-Map=.pio/build/stm32h723vg/firmware.map
    -Og
    -g
    -ICore/Inc
    -IDrivers/STM32H7xx_HAL_Driver/Inc
    -IDrivers/STM32H7xx_HAL_Driver/Inc/Legacy
    -IDrivers/CMSIS/Device/ST/STM32H7xx/Include
    -IDrivers/CMSIS/Include

; 禁用所有框架默认标志
build_unflags = 
    -Os
    -O2
    -mfpu=fpv5-d16
    -mfloat-abi=hard

; 使用简化的源文件过滤器
build_src_filter = 
    +<*>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_cortex.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_rcc.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_rcc_ex.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_flash.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_flash_ex.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_gpio.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_pwr.c>
    +<../Drivers/STM32H7xx_HAL_Driver/Src/stm32h7xx_hal_pwr_ex.c>

; 禁用库依赖查找和框架库
lib_ldf_mode = off
lib_compat_mode = off

; 使用自定义链接脚本
board_build.ldscript = STM32H723XG_FLASH.ld

; 确保MCU设置正确
board_build.mcu = stm32h723vgt6
board_build.f_cpu = 550000000L
board_build.f_flash = 1048576
board_build.f_ram = 573440

; 监控串口设置
monitor_speed = 115200

; 额外的库依赖（如果需要）
lib_deps = 

; 调试配置
debug_init_break = tbreak main
debug_load_mode = always
debug_build_flags = 
    -O0
    -g3
    -ggdb
    -DDEBUG

; 调试服务器配置
debug_server =
    $PLATFORMIO_CORE_DIR/packages/tool-openocd/bin/openocd
    -f
    interface/cmsis-dap.cfg
    -f
    target/stm32h7x.cfg

; 如果您使用的是自定义板子而不是标准开发板，请取消注释并配置以下选项：
; board_build.mcu = stm32h723vgt6
; board_build.f_cpu = 550000000L
; board_build.f_flash = 8000000L
